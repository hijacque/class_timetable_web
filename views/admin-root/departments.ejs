<% const {colleges, currentCollege} = data %>
<div class="bg-light task-view" id="departments-view">
    <div class="side-panel">
        <div class="panel-header mx-4">
            <div class="d-flex justify-content-between">
                <h4>Colleges</h4>
                <div>
                    <a type="button"><i class="fas fa-sort-alpha-up-alt"></i></a>
                    <a type="button"><i class="fas fa-search ms-2"></i></a>
                </div>
            </div>
            <div class="input-group">
                <input type="text" class="form-control" placeholder="New College" aria-describedby="add-college">
                <a type="button" class="input-group-text" id="add-college">
                    <i class="fas fa-plus text-primary"></i>
                </a>
            </div>
        </div>
        <hr>
        <div class="mx-3 panel-body">
            <% if (colleges.length> 0) { %>
                <ul class="list-group panel-menu">
                    <% for (const college of colleges) { %>
                        <a type="button" class="list-group-item list-group-item-action menu-item"
                            title="<%= college.name %>" 
                            <% if (college != currentCollege) { %>
                                href="/admin/departments/<%= college.name.split(' ').join('_') %>"
                            <% } %>
                            >
                            <p class="text-truncate m-0">
                                <%= college.name %>
                            </p>
                        </a>
                        <% } %>
                </ul>
                <% } else { %>
                    <p class="text-muted text-center">No Colleges</p>
                <% } %>
        </div>
    </div>
    <div class="shadow-3 bg-white px-5 pt-4">
        <% if (colleges.length > 0 && currentCollege) { %>
            <h2 style="color: #8673b4;" class="table-title"></h2>
            <br>
            <button class="btn btn-primary btn-rounded" data-cts-toggle="table" data-cts-target="#departments-table">
                <i class="fas fa-edit fa-lg me-2"></i>edit table</button>
            <button class="btn btn-success btn-rounded" data-cts-dismiss="table" data-cts-target="#departments-table"
                aria-hidden="true">save changes</button>
            <table class="table table-bordered table-sm fw-bold my-4" id="departments-table">
                <thead class="text-center">
                    <tr>
                        <th table-cts-column="department text" style="width: 300px;">Department</th>
                        <th table-cts-column="chairperson" style="width: 400px;">Chairperson</th>
                        <th table-cts-column="activity">Recent Activity</th>
                        <td table-cts-column="edit">Action</td>
                    </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                    <tr class="add-data">
                        <td><input type="text" class="form-control add-td-input unique"></td>
                        <td><label class="add-td-input optional"></label></td>
                        <td><label class="add-td-input optional"></label></td>
                    </tr>
                </tfoot>
            </table>
        <% } else if (currentCollege) { %>
            <h4>No</h4>
        <% } %>
    </div>
</div>
<script src="/lib/responsive-table.js"></script>
<script>
    async function initDeptEdit(event) {
        // get current chairperson
        let chairColumn = $(event.currentTarget).children().get(1);
        let origItem = $(chairColumn).text();
        if (origItem == "" || origItem == "NULL") {
            return;
        }

        $(event.currentTarget).data("prevChair", origItem);
        let deptID = departmentsTable.data[$(event.currentTarget).index()]["id"];
        // get all faculty in the department
        let faculty = await getFaculty(deptID, ["faculty_id", "last_name", "first_name", "middle_name"]);
        if (faculty.length <= 1) {
            return;
        }

        // create dropdown list of faculty
        let dropMenu = "<ul class='dropdown-menu'>";
        for (const name of faculty) {
            let facultyName = `${name.last_name}, ${name.first_name} ${name.middle_name}`;
            dropMenu += `<li><a class="dropdown-item" role="button">${facultyName} (${name.faculty_id})</a></li>`;
        }
        dropMenu += "</ul>";
        $(chairColumn).empty().append(
            `<div class="dropdown">` +
            `<button class="btn btn-secondary dropdown-toggle td-input" type="button" ` +
            `id="chairperson" data-mdb-toggle="dropdown" aria-expanded="false" ` +
            `title="${origItem}">${origItem}</button>${dropMenu}` +
            `</div>`
        );
        departmentsTable.initMenuInputs(event.currentTarget);
    }

    async function confirmDeptEdit(event) {
        const action = $(event.currentTarget).data("edit-action");
        if (!action) {
            console.log($(event.currentTarget).data("deletedData"));
            console.log("Deleting from db...");
            return;
        }
        const [deptColumn, chairColumn] = $(event.currentTarget).children().get();
        let newChair = $(chairColumn).text();
        const deptID = departmentsTable.data[$(event.currentTarget).index()]["id"];
        let prevChair = $(event.currentTarget).data("prevChair");
        if (prevChair == "NULL" || prevChair == newChair) {
            return console.log("Chairperson unchanged.");
        }
        try {
            const message = await updateDepartment(deptID, { deptName: deptColumn.value, chair: newChair });
            alertModal.show(...Object.values(message));
        } catch (error) {
            console.error(error);
            const { message, redirect } = error.responseJSON;
            if (redirect) {
                location.replace(redirect);
            }

            $(event.currentTarget).trigger("row:cancel-change");
            alertModal.show(...Object.values(message));
        }
    }

    async function cancelDeptEdit(event) {
        if ($(event.currentTarget).data("edit-action") == 1) {
            const chairColumn = $(event.currentTarget).children().get(1);
            let prevChair = $(event.currentTarget).data("prevChair");
            chairColumn.textContent = prevChair;
        }
    }

    $("#add-college").click(async (event) => {
        let collegeName = $(event.currentTarget).siblings("input:first").val();
        if (!collegeName || collegeName == "") {
            return alertModal.show(2, "Missing Input", "Enter a new college name.");
        } else if (colleges.is(`[title='${collegeName}']`)) {
            return alertModal.show(
                2, "Duplicate College",
                "Please enter a different college name."
            );
        }

        try {
            await addCollege(collegeName);
            location.replace("/admin/departments/" + collegeName.split(" ").join("_"));
        } catch (error) {
            console.log(error);
        }
    });

    /*
    * main process starts here
    */
    const colleges = $(".panel-menu > .menu-item");
    const departmentsTable = new EditableTable("#departments-table");
    if (colleges.length > 0) {
        let openCollege = $(".menu-item[title='<%= currentCollege.name %>']");
        $(openCollege).addClass("active");
        let collegeTitle = $(".table-title");

        // initialize responsive Departments table
        departmentsTable.initData(getDepartments("<%= currentCollege.id %>"), true, 
            () => $(`${departmentsTable.body}>tr`)
                .on("row:edit", initDeptEdit)
                .on("row:confirm-change", confirmDeptEdit)
                .on("row:cancel-change", cancelDeptEdit)
        );
        $(collegeTitle).text("Departments in " + $(openCollege).text());

        $(departmentsTable.addBtn).click(async (event) => {
            let newDeptData;
            try {
                newDeptData = await $(event.currentTarget).data("newRow");
            } catch (error) {
                return console.error(error);
            }

            try {
                const message = await addDepartment("<%= currentCollege.id %>", newDeptData);
                alertModal.show(...Object.values(message));
            } catch (error) {
                console.error(error);
                const { message, redirect } = error.responseJSON;
                if (redirect) {
                    location.replace(redirect);
                }

                $(`${departmentsTable.body}>tr:last-child`).remove();
                departmentsTable.data.pop();
                alertModal.show(...Object.values(message));
            }
            $(event.currentTarget).removeData("newRow");
        });
    }
</script>