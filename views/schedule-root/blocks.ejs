<% const {classes, deptClasses, otherClasses, current, courseID, prevBlock, nextBlock, faculty} = data %>
<% if (status == 'open') { %>
<div class="modal fade" id="schedule-class" data-mdb-backdrop="static" data-mdb-keyboard="false"
    tabindex="-1" aria-labelledby="add-class-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="schedule-class-label"></h5>
                <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <label for="class-subject">Subject:</label><span id="class-subject"></span><br>
                <label for="class-block">Block:</label>
                <span id="class-block"><%= current.course %> <%= current.year %>-<%= current.block_no %></span><br>
                <label for="class-hours">Assigned hours:</label>
                <span id="class-hours"></span><br>
                <div class="d-flex align-items-center my-1" >
                    <label for="class-faculty" class="fw-bold me-2">Faculty:</label>
                    <span class="class-faculty"></span>
                    <div class="dropdown">
                        <a class="btn btn-secondary dropdown-toggle class-faculty" type="button"
                            data-mdb-toggle="dropdown" aria-expanded="false">pick professor</a>
                        <ul class="dropdown-menu" aria-labelledby="class-faculty">
                            <% for (const prof of faculty) { %>
                                <li><a class="dropdown-item px-3" role="button" id="<%= prof.id %>">
                                    <% if (prof.teach_load == "FULL") { %>
                                        <span class="text-warning faculty-name"><%= prof.name %></span>
                                        <span class="faculty-load">( <%= prof.teach_load %> )</span>
                                    <% } else { %>
                                        <span class="faculty-name"><%= prof.name %></span>
                                        <span class="faculty-load">( <%= prof.teach_load %> )</span>
                                    <% } %>
                                </a></li>
                            <% } %>
                            <li><hr class="dropdown-divider m-0"></li>
                            <li><a class="dropdown-item text-danger cancel" role="button">Cancel</a></li>
                        </ul>
                    </div>
                </div>
                <hr>
                <p><small>Class Schedule</small></p>
                <div class="input-group mb-2">
                    <div class="dropdown">
                        <a class="text-primary dropdown-toggle input-group-text rounded-0 rounded-start" type="button"
                            data-mdb-toggle="dropdown" aria-expanded="false" id="class-day">Pick Day</a>
                        <ul class="dropdown-menu" aria-labelledby="class-day">
                            <li><a class="dropdown-item" role="button" data-cts-enum="1">MONDAY</a></li>
                            <li><a class="dropdown-item" role="button" data-cts-enum="2">TUESDAY</a></li>
                            <li><a class="dropdown-item" role="button" data-cts-enum="3">WEDNESDAY</a></li>
                            <li><a class="dropdown-item" role="button" data-cts-enum="4">THURSDAY</a></li>
                            <li><a class="dropdown-item" role="button" data-cts-enum="5">FRIDAY</a></li>
                            <li><a class="dropdown-item" role="button" data-cts-enum="6">SATURDAY</a></li>
                            <li><a class="dropdown-item" role="button" data-cts-enum="7">SUNDAY</a></li>
                            <li><hr class="dropdown-divider m-0"></li>
                            <li><a class="dropdown-item text-danger cancel" type="button">Cancel</a></li>
                        </ul>
                    </div>
                    <span class="input-group-text"><i class="fas fa-at"></i></span>
                    <input type="time" id="class-start" class="form-control">
                    <span class="input-group-text"> - </span>
                    <input type="time" id="class-end" class="form-control">
                </div>
                <div class="input-group mb-3">
                    <div class="dropdown">
                        <a class="text-primary dropdown-toggle input-group-text rounded-0 rounded-start" type="button"
                            data-mdb-toggle="dropdown" aria-expanded="false" id="class-mode">Pick Mode</a>
                        <ul class="dropdown-menu" aria-labelledby="class-mode">
                            <li><a class="dropdown-item" role="button" data-cts-enum="1">F2F</a></li>
                            <li><a class="dropdown-item" role="button" data-cts-enum="2">Online</a></li>
                            <li><a class="dropdown-item" role="button" data-cts-enum="3">Blended</a></li>
                            <li><hr class="dropdown-divider m-0"></li>
                            <li><a class="dropdown-item text-danger cancel" type="button">Cancel</a></li>
                        </ul>
                    </div>
                    <input type="text" id="class-room" class="form-control" placeholder="Room no." disabled>
                </div>
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <div>
                    <button type="button" class="btn btn-danger" id="delete-schedule" data-mdb-dismiss="modal">delete</button>
                </div>
                
                <div>
                    <button type="button" class="btn btn-secondary me-2" data-mdb-dismiss="modal">cancel</button>
                    <button type="button" class="btn btn-warning me-2" id="reset-schedule">reset</button>
                    <button type="button" class="btn btn-primary" id="change-schedule" data-mdb-dismiss="modal">change</button>
                    <button type="button" class="btn btn-primary" id="add-schedule" data-mdb-dismiss="modal">assign</button>
                </div>
            </div>
        </div>
    </div>
</div>
<% } %>
<div class="main-view">
    <div>
        <nav aria-label="Schedule Navigation for Blocks">   
            <ul class="pagination" id="schedule-nav">
                <% if (prevBlock) { %>
                    <% const {year, ordinal_year, block_no} = prevBlock %>
                    <li class="page-item">
                        <a href="/schedule/<%= courseID %>?term=<%= term.code %>&year=<%= year %>&block=<%= block_no %>"
                            class="page-link me-2" type="button" ><i class="fas fa-chevron-left"></i></a>
                        <p class="prev page-label"><%- ordinal_year %> year, Block <%= block_no %></p>
                    </li>
                <% } else { %>
                    <li class="page-item disabled">
                        <a class="page-link me-2" type="button"><i class="fas fa-chevron-left"></i></a>
                        <p class="prev page-label"></p>
                    </li>
                <% } %>
                    <li class="page-item">
                        <h4 class="text-center mt-2" style="color:#b9aadc"><%= current.course %></h4>
                    </li>
                <% if (nextBlock) { %>
                    <% const {year, ordinal_year, block_no} = nextBlock %>
                    <li class="justify-content-end page-item">
                        <p class="next page-label"><%- ordinal_year %> year, Block <%= block_no %></p>
                        <a href="/schedule/<%= courseID %>?term=<%= term.code %>&year=<%= year %>&block=<%= block_no %>" 
                            class="page-link ms-2" type="button"><i class="fas fa-chevron-right"></i></a>
                    </li>
                <% } else { %>
                    <li class="justify-content-end page-item disabled">
                        <p class="next page-label"></p>
                        <a class="page-link ms-2" type="button"><i class="fas fa-chevron-right"></i></a>
                    </li>
                <% } %>
            </ul>    
        </nav>
        <% const {id, year, ordinal_year, block_no, course} = current %>
        <form method="post" target="export_schedule" action="/schedule/download/<%= term.code %>/block" 
            class="about d-flex mt-4" onsubmit="window.open('_blank','export_schedule');">
            <h4 class="page-title"><%- ordinal_year %> year, Block <%= block_no %></h4>
            <input type="hidden" name="year" value="<%= year %>">
            <input type="hidden" name="block_no" value="<%= block_no %>">
            <input type="hidden" name="courseID" value="<%= courseID %>">
            <input type="hidden" name="course" value="<%= course %>">
            <button type="submit" class="ms-4 btn btn-secondary btn-floating" title="Export schedules">
                <i class="fas fa-cloud-arrow-down fa-lg"></i>
            </button>
        </form>
        <div class="scheduler">
            <div></div>
            <div class="days">
                <div>MON</div>
                <div>TUE</div>
                <div>WED</div>
                <div>THU</div>
                <div>FRI</div>
                <div>SAT</div>
                <div>SUN</div>
            </div>
            <div class="times">
                <div>7 AM</div>
                <div>8 AM</div>
                <div>9 AM</div>
                <div>10 AM</div>
                <div>11 AM</div>
                <div>12 PM</div>
                <div>1 PM</div>
                <div>2 PM</div>
                <div>3 PM</div>
                <div>4 PM</div>
                <div>5 PM</div>
                <div>6 PM</div>
                <div>7 PM</div>
                <div>8 PM</div>
                <div>9 PM</div>
                <div>10 PM</div>
            </div>
            <div class="schedules">
                <div class="sched-grid">
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                </div>
                <div class="sched-body">
                    <% for (const schedule of classes) { %>
                        <div data-mdb-toggle="tooltip" data-mdb-html="true"
                            class="sched-block<%= (schedule.departmental) ? ' dept-subj' : '' %><%= (schedule.partial) ? ' partial' : '' %>"
                            <% if (schedule.room) { %>
                            title="<b><%= schedule.subject %></b><br><small>Prof. <%= schedule.faculty_name %><br><i><%= schedule.mode %> @ <%= schedule.room %></i></small>"
                            <% } else { %>
                            title="<b><%= schedule.subject %></b><br><small>Prof. <%= schedule.faculty_name %><br><i><%= schedule.mode %></i></small>"
                            <% } %>
                            style="grid-column: <%= schedule.day %> / span 1; grid-row: <%= schedule.start_time %> / <%= schedule.end_time %>;"
                            aria-valuemin="<%= schedule.start %>" aria-valuemax="<%= schedule.end %>" 
                            aria-valuenow="<%= schedule.day %>" aria-current="<%= schedule.duration %>">
                            <h6 class="text-break subject" itemid="<%= schedule.subj_id %>">
                                <%= schedule.subject %>
                            </h6>
                            <p class="text-truncate"><small>
                                Prof. <span class="faculty" itemid="<%= schedule.faculty_id %>">
                                    <%= schedule.faculty_name %>
                                </span><br>
                                <% if (schedule.room) { %>
                                    <i>
                                        <span class="mode"><%= schedule.mode %></span> @ 
                                        <span class="room" itemid="<%= schedule.room_id %>"><%= schedule.room %></span>
                                    </i>
                                <% } else { %>
                                    <i class="mode"><%= schedule.mode %></i>
                                <% } %>
                            </small></p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
    <div class="side-panel">
        <div class="panel-header mx-4">
            <h5>Unassigned Classes</h5>
        </div>
        <div class="panel-body">
            <a type="button" class="collapse-btn" data-mdb-toggle="collapse" data-mdb-target="#department-classes"
                aria-expanded="false">
                <i class="fas fa-caret-down me-2"></i><text>Departmental Classes</text>
            </a>
            <% if (deptClasses.length> 0 && status == 'open') { %>
                <div class="collapse show" id="department-classes">
                    <div>
                        <ul class="list-group panel-menu">
                            <% for (const {subj_id, subject, req_hours, assigned_time, faculty_id, faculty_name} of deptClasses) { %>
                                <button type="button" title="<%= subject %>" id="<%= subj_id %>"
                                    class="list-group-item list-group-item-action menu-item"
                                    <% if (faculty_id) { %>
                                        itemid="<%= faculty_id %>"
                                    <% } %>
                                    aria-valuemax="<%= req_hours || 0 %>"
                                    aria-valuenow="<%= assigned_time || 0 %>">
                                    <p class="text-truncate m-0">
                                        <%= subject %><br>
                                        <% if (faculty_id) { %>
                                            <small class="text-muted faculty-name">Professor: <%= faculty_name %></small>
                                        <% } %>
                                    </p>
                                </button>
                            <% } %>
                        </ul>
                    </div>
                </div>
            <% } else if (deptClasses.length> 0) { %>
                <div class="collapse show" id="department-classes">
                    <p>Faculty schedules closed</p>
                </div>
            <% } else { %>
                <div class="collapse show" id="department-classes">
                    <p>No more classes to assign</p>
                </div>
            <% } %>
            <a type="button" class="collapse-btn" data-mdb-toggle="collapse" data-mdb-target="#other-classes" 
                aria-expanded="false"><i class="fas fa-caret-down me-2"></i><text>Other Classes</text>
            </a>
            <% if (otherClasses.length> 0) { %>
                <div class="collapse show" id="other-classes">
                    <div>
                        <ul class="list-group">
                            <% for (const {subj_id, subject, req_hours, assigned_time, faculty_id, faculty_name} of otherClasses) { %>
                                <button type="button" title="<%= subject %>" id="<%= subj_id %>"
                                    class="list-group-item list-group-item-action"
                                    <% if (faculty_id) { %>
                                        itemid="<%= faculty_id %>"
                                    <% } %>
                                    aria-valuemax="<%= req_hours || 0 %>"
                                    aria-valuenow="<%= assigned_time || 0 %>">
                                    <p class="text-truncate m-0">
                                        <%= subject %><br>
                                        <% if (faculty_id) { %>
                                            <small class="text-muted faculty-name">Professor: <%= faculty_name %></small>
                                        <% } %>
                                    </p>
                                </button>
                            <% } %>
                        </ul>
                    </div>
                </div>
            <% } else { %>
                <div class="collapse" id="other-classes">
                    <p>No more classes to assign</p>
                </div>
            <% } %>
        </div>
    </div>
</div>

<% if (status == 'open') { %>
<script src="/lib/display-dropdown.js"></script>
<script>
    let currentSched = {block: "<%= current.id %>"}
    const addClass = (schedule) => new Promise((resolve, reject) => {
        $.post(
            "/api/schedules/<%= term.id %>", { schedule: schedule }, () => location.reload()
        ).fail((error) => {
            console.log(error);
            reject(error.responseJSON || error.responseText);
        });
    });

    const manageClass = (action, newSchedule = {}) => new Promise((resolve, reject) => {
        $.post(
            "/api/schedule/<%= term.id %>",
            { oldSched: currentSched, newSched: newSchedule, action: action }, 
            () => location.reload()
        ).fail((error) => reject(error.responseJSON));
    });
    
    $(".menu-item").click((event) => {
        const newClass = event.currentTarget;
        $("#class-subject").text(newClass.title).attr("aria-valuenow", newClass.id);
        const assignedHours = parseFloat(newClass.ariaValueNow);
        const reqHours = parseInt(newClass.ariaValueMax);
        $("#class-hours")
            .text(`${assignedHours} / ${reqHours}`)
            .attr("aria-valuemax", reqHours - assignedHours)
            .attr("aria-valuemin", assignedHours);
        
        const facultyID = newClass.getAttribute("itemid");
        if (facultyID && facultyID != "") {
            const facultyName = $(newClass).find(".faculty-name").text().slice(11);
            $("span.class-faculty").text(facultyName).attr("aria-valuenow", facultyID);
            $("a.dropdown-toggle.class-faculty").hide();
        } else {
            $("span.class-faculty").empty();
            $("a.dropdown-toggle.class-faculty").show();
        }
        
        $("#schedule-class-label").text("Assign New Class");
        $("#add-schedule").show();
        $("#change-schedule, #delete-schedule, #reset-schedule").hide();
        scheduleForm.show();
    });

    $(".sched-block").click((event) => {
        const prevClass = event.currentTarget;
        $("#schedule-class-label").text("Change Class Schedule");
        const [subj, faculty, mode, room] = $(prevClass).find(".subject, .faculty, .mode, .room");
        console.log(prevClass.ariaValueMin, prevClass.ariaValueMax, prevClass.ariaValueNow);
        $("#class-subject").text(subj.textContent).attr("aria-valuenow", subj.getAttribute("itemid"));
        $("#class-start").val(prevClass.ariaValueMin);
        $("#class-end").val(prevClass.ariaValueMax);
        $("#class-hours").text(prevClass.ariaCurrent).attr("aria-valuemax", prevClass.ariaCurrent);

        currentSched.faculty = faculty.getAttribute("itemid");
        currentSched.subject = subj.getAttribute("itemid");
        currentSched.day = prevClass.ariaValueNow;
        currentSched.start_time = prevClass.ariaValueMin;
        currentSched.end_time = prevClass.ariaValueMax;
        currentSched.start = roundMinutes(prevClass.ariaValueMin);
        currentSched.end = roundMinutes(prevClass.ariaValueMax);
        currentSched.mode = mode.textContent;
        currentSched.partial = prevClass.classList.contains("partial");
        
        $(`ul[aria-labelledby='class-day']>li:nth-child(${prevClass.ariaValueNow})>a.dropdown-item`).trigger("click");
        $(`ul[aria-labelledby='class-mode']>li>a.dropdown-item:contains(${mode.textContent})`).trigger("click");

        if (currentSched.partial) {
            $("a.class-faculty").hide().attr("aria-valuenow", null);
            $("span.class-faculty").text(faculty.textContent).attr("aria-valuenow", faculty.getAttribute("itemid")).show();
        } else {
            $("span.class-faculty").hide().attr("aria-valuenow", null);
            $("a.class-faculty").show();
            $(`ul[aria-labelledby='class-faculty']>li>a#${faculty.getAttribute("itemid")}.dropdown-item`).trigger("click");
        }

        if (room) {
            $("#class-room").val(room.textContent);
            currentSched.room_name = room.textContent;
            currentSched.room_id = room.getAttribute("itemid");
        } else {
            delete currentSched.room_name;
            delete currentSched.room_id;
        }
        
        console.log(currentSched);
        $("#add-schedule").hide();
        $("#change-schedule, #delete-schedule, #reset-schedule").show();
        scheduleForm.show();
    });

    $("[aria-labelledby='class-day'] > li > a.dropdown-item").click((event) => {
        const dayIndex = event.currentTarget.getAttribute("data-cts-enum");
        if (!dayIndex) return $("#class-day").attr("aria-valuenow", null);

        $("#class-day").attr("aria-valuenow", dayIndex);
        $("#class-start").focus();
    });

    $("[aria-labelledby='class-mode'] > li > a.dropdown-item").click((event) => {
        const modeIndex = event.currentTarget.getAttribute("data-cts-enum");
        if (!modeIndex) {
            $("#class-room").val(null).prop("disabled", true);
            return $("#class-room").attr("aria-valuenow", null);
        }

        $("#class-mode").attr("aria-valuenow", modeIndex);
        if (modeIndex == 1) {
            $("#class-room").prop("disabled", false).focus();
        } else {
            $("#class-room").val(null).prop("disabled", true);
        }
    });

    $("[aria-labelledby='class-faculty'] > li > a.dropdown-item").click((event) => {
        $("a.dropdown-toggle.class-faculty")
            .attr("aria-valuenow", event.currentTarget.id)
            .text($(event.currentTarget).find(".faculty-name").text());
    });

    $("#reset-schedule").click(async (event) => {
        console.log(currentSched);
        $("#class-end").val(currentSched.end_time);
        $("#class-start").text(currentSched.start_time);
        if (!currentSched.partial) {
            $(`ul[aria-labelledby='class-faculty']>li>a#${currentSched.faculty}.dropdown-item`).trigger("click");
        }
        $(`ul[aria-labelledby='class-day']>li:nth-child(${currentSched.day})>a.dropdown-item`).trigger("click");
        $(`ul[aria-labelledby='class-mode']>li>a.dropdown-item:contains(${currentSched.mode})`).trigger("click");
        if (currentSched.room_id) {
            $("#class-room").val(currentSched.room_name);
        }
    });

    $("#change-schedule").click(async (event) => {
        const validTime = validateScheduleInput();
        if (!validTime) return;
        
        try {
            // console.log({
            //     faculty: $(".class-faculty[aria-valuenow]").attr("aria-valuenow"),
            //     subject: $("#class-subject").attr("aria-valuenow"),
            //     mode: $("#class-mode").attr("aria-valuenow") || 1,
            //     room: $("#class-room").val().toLowerCase(),
            //     block: "<%= current.id %>",
            //     day: $("#class-day").attr("aria-valuenow"),
            //     start: validTime.startTime,
            //     end: validTime.endTime
            // });
            await manageClass("change", {
                faculty: $(".class-faculty[aria-valuenow]").attr("aria-valuenow"),
                subject: $("#class-subject").attr("aria-valuenow"),
                mode: $("#class-mode").attr("aria-valuenow") || 1,
                room: $("#class-room").val().toLowerCase(),
                block: "<%= current.id %>",
                day: $("#class-day").attr("aria-valuenow"),
                start: validTime.startTime,
                end: validTime.endTime
            });
        } catch (eResponse) {
            console.log(eResponse);
            if (eResponse) {
                if (eResponse.redirect) {
                    location.replace(eResponse.redirect);
                }
                if (eResponse.message) {
                    console.log(eResponse.message);
                    $("#confirm-alert").attr("data-mdb-target", "#schedule-class").attr("data-mdb-toggle", "modal");
                    alertModal.show(...Object.values(eResponse.message));
                }
            } else {
                $("#confirm-alert").attr("data-mdb-target", "#schedule-class").attr("data-mdb-toggle", "modal");
                alertModal.show(0, "Server error", "Unexpected error occured, please try again later.");
            }
        }
    });

    $("#delete-schedule").click(async (event) => {
        try {
            await manageClass("delete");
        } catch (eResponse) {
            if (eResponse) {
                if (eResponse.redirect) {
                    location.replace(eResponse.redirect);
                }
                if (eResponse.message) {
                    $("#confirm-alert").attr("data-mdb-target", "#schedule-class").attr("data-mdb-toggle", "modal");
                    alertModal.show(...Object.values(eResponse.message));
                }
            } else {
                $("#confirm-alert").attr("data-mdb-target", "#schedule-class").attr("data-mdb-toggle", "modal");
                alertModal.show(0, "Server error", "Unexpected error occured, please try again later.");
            }
        }
    });

    $("#add-schedule").click(async (event) => {
        const validTime = validateScheduleInput();
        if (!validTime) return;

        try {
            console.log({
                faculty: $(".class-faculty[aria-valuenow]").attr("aria-valuenow"),
                subject: $("#class-subject").attr("aria-valuenow"),
                mode: $("#class-mode").attr("aria-valuenow") || 1,
                room: $("#class-room").val().toLowerCase(),
                block: "<%= current.id %>",
                day: $("#class-day").attr("aria-valuenow"),
                start: validTime.startTime,
                end: validTime.endTime,
                partial: parseFloat($("#class-hours").attr("aria-valuemin")) > 0 ? 1 : 0
            });
            await addClass({
                faculty: $(".class-faculty[aria-valuenow]").attr("aria-valuenow"),
                subject: $("#class-subject").attr("aria-valuenow"),
                mode: $("#class-mode").attr("aria-valuenow") || 1,
                room: $("#class-room").val().toLowerCase(),
                block: "<%= current.id %>",
                day: $("#class-day").attr("aria-valuenow"),
                start: validTime.startTime,
                end: validTime.endTime,
                partial: parseFloat($("#class-hours").attr("aria-valuemin")) > 0 ? 1 : 0
            });
            // $(".sched-body").append(
            //     `<div class="sched-block" title="${subject.text()}\n` +
            //         `Prof. ${faculty.text()}\n${mode.text()} ${schedule.room ? "@ " + schedule.room : ""}"` +
            //         `style="grid-column: ${schedule.day} / span 1; ` +
            //         `grid-row: ${schedule.start} / ${schedule.end};">` +
            //     `<h6 class="text-break">${subject.text()}</h6>` +
            //     `<p class="text-truncate"><small>` +
            //         `Prof. ${faculty.text()}<br>${mode.text()} ` +
            //         `${schedule.room ? "@ " + schedule.room : ""}</small></p>`
            // );
            // location.reload();
            // $(".main-view > div:last-child").scrollTop(0);
            // scrollToFirstSched(schedule.start);
            // alertModal.show(...Object.values(message));
            // $(`.menu-item#${subject.attr("aria-valuenow")}`).remove();
            // resetClassForm();
        } catch (eResponse) {
            if (eResponse) {
                if (eResponse.redirect) {
                    location.replace(eResponse.redirect);
                }
                if (eResponse.message) {
                    $("#confirm-alert").attr("data-mdb-target", "#schedule-class").attr("data-mdb-toggle", "modal");
                    alertModal.show(...Object.values(eResponse.message));
                }
            } else {
                $("#confirm-alert").attr("data-mdb-target", "#schedule-class").attr("data-mdb-toggle", "modal");
                alertModal.show(0, "Server error", "Unexpected error occured, please try again later.");
            }
        }
    });

    function validateScheduleInput() {
        const day = $("#class-day");
        const start = $("#class-start");
        const end = $("#class-end");
        const hours = $("#class-hours");
        const reqMinutes = parseFloat(hours.attr("aria-valuemax")) * 60;
        if (day.text() == "Pick Day" || !start.val() || !end.val()) {
            $("#confirm-alert").attr("data-mdb-target", "#schedule-class").attr("data-mdb-toggle", "modal");
            alertModal.show(2, "Missing schedule input", "Fill in week day, start time and end time.");
            return false;
        } else if (start.val() > end.val()) {
            $("#confirm-alert").attr("data-mdb-target", "#schedule-class").attr("data-mdb-toggle", "modal");
            alertModal.show(2, "Invalid time input", "End time is earlier than start time");
            return false;
        }
        const startTime = roundMinutes(start.val(), 30);
        if (startTime < 7 * 60) {
            $("#confirm-alert").attr("data-mdb-target", "#schedule-class").attr("data-mdb-toggle", "modal");
            alertModal.show(2, "Start time is too early", "Class must start on or later than 7AM");
            return false;
        }
        
        const endTime = roundMinutes(end.val(), 30);
        if (endTime > 22 * 60) {
            $("#confirm-alert").attr("data-mdb-target", "#schedule-class").attr("data-mdb-toggle", "modal");
            alertModal.show(2, "End time is too late", "Class must end on or before than 10PM");
            return false;
        } else if (endTime - startTime > reqMinutes) {
            $("#confirm-alert").attr("data-mdb-target", "#schedule-class").attr("data-mdb-toggle", "modal");
            alertModal.show(2, "Invalid time input", "Assigned time exceeds required hours.");
            return false;
        }

        return {startTime: startTime, endTime: endTime};
    }

    function roundMinutes(time, nearestMinutes = 1) {
        let [hours, mins] = time.split(":");
        let toMins = parseInt(hours) * 60 + parseInt(mins);
        const rounded = Math.round(toMins / nearestMinutes) * nearestMinutes;
        const finalMins = rounded % 60;
        const finalHours = (rounded - finalMins);
        return finalHours + finalMins;
    }

    $(document).ready(() => setTimeout(() => {
        const startHeight = <%- JSON.stringify(Math.min(...classes.map(c => c.start)) || 0) %>;
        if (startHeight > 9) {
            $(".main-view>div:last-child").stop().animate({scrollTop: startHeight * 50 + 107}, 1000, 'swing');
        }
    }, 300));
    
    displayDropMenu($("#class-day"), "Pick Day");
    displayDropMenu($("#class-mode"), "Pick Mode");
    displayDropMenu($("#class-faculty"), "Pick Professor");
</script>
<% } %>