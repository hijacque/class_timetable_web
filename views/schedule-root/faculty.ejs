<% const {prevFaculty, nextFaculty, current} = schedule %>
<% const {id, name} = current %>
<div class="modal fade" id="add-class" data-mdb-backdrop="static" data-mdb-keyboard="false"
    tabindex="-1" aria-labelledby="add-class-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="add-class-label">Assign New Class</h5>
                <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <label for="class-subject">Subject:</label><span id="class-subject"></span><br>
                <label for="class-block">Block:</label><span id="class-block"></span><br>
                <label for="class-faculty">Faculty:</label>
                <span id="class-faculty"><%= name %></span><br>
                <label for="class-hours">Assigned hours:</label>
                <span id="class-hours"></span>
                <hr>
                <p><small>Class Schedule</small></p>
                <div class="input-group mb-2">
                    <div class="dropdown">
                        <a class="text-primary dropdown-toggle input-group-text rounded-end-0" type="button"
                            data-mdb-toggle="dropdown" aria-expanded="false" id="class-day">Pick Day</a>
                        <ul class="dropdown-menu" aria-labelledby="class-day">
                            <li><a class="dropdown-item" role="button" data-cts-enum="1">MONDAY</a></li>
                            <li><a class="dropdown-item" role="button" data-cts-enum="2">TUESDAY</a></li>
                            <li><a class="dropdown-item" role="button" data-cts-enum="3">WEDNESDAY</a></li>
                            <li><a class="dropdown-item" role="button" data-cts-enum="4">THURSDAY</a></li>
                            <li><a class="dropdown-item" role="button" data-cts-enum="5">FRIDAY</a></li>
                            <li><a class="dropdown-item" role="button" data-cts-enum="6">SATURDAY</a></li>
                            <li><a class="dropdown-item" role="button" data-cts-enum="7">SUNDAY</a></li>
                            <li><hr class="dropdown-divider m-0"></li>
                            <li><a class="dropdown-item text-danger" role="button">Cancel</a></li>
                        </ul>
                    </div>
                    <span class="input-group-text"><i class="fas fa-at"></i></span>
                    <input type="time" id="class-start" class="form-control">
                    <span class="input-group-text"> - </span>
                    <input type="time" id="class-end" class="form-control">
                </div>
                <div class="input-group mb-3">
                    <div class="dropdown">
                        <a class="text-primary dropdown-toggle input-group-text rounded-end-0" type="button"
                            data-mdb-toggle="dropdown" aria-expanded="false" id="class-mode">Pick Mode</a>
                        <ul class="dropdown-menu" aria-labelledby="class-mode">
                            <li><a class="dropdown-item" role="button" data-cts-enum="1">F2F</a></li>
                            <li><a class="dropdown-item" role="button" data-cts-enum="2">online</a></li>
                            <li><a class="dropdown-item" role="button" data-cts-enum="3">blended</a></li>
                            <li><hr class="dropdown-divider m-0"></li>
                            <li><a class="dropdown-item text-danger" role="button">Cancel</a></li>
                        </ul>
                    </div>
                    <!-- <input type="text" id="class-bldg" class="form-control" placeholder="Building" disabled> -->
                    <input type="text" id="class-room" class="form-control" placeholder="Room no." disabled>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-mdb-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-new-class">Assign</button>
            </div>
        </div>
    </div>
</div>
<div class="main-view">
    <div class="side-panel">
        <div class="panel-header mx-4 mb-3">
            <h5>Unassigned Classes</h5>
        </div>
        <div class="panel-body">
            <a type="button" class="collapse-btn" data-mdb-toggle="collapse" data-mdb-target="#department-classes"
                aria-expanded="false">
                <i class="fas fa-caret-down me-2"></i><text>Departmental Classes</text>
            </a>
            <% if (deptClasses.length> 0) { %>
                <div class="collapse show" id="department-classes">
                    <div>
                        <h6 class="block-title">
                            <small><%= deptClasses[0].course %></small><br>
                            Year <%= deptClasses[0].year %> - Block <%= deptClasses[0].block_no %>
                        </h6>
                        <ul class="list-group panel-menu" id="<%= deptClasses[0].block_id %>"
                            title="<%= deptClasses[0].course %> <%= deptClasses[0].year %> - <%= deptClasses[0].block_no %>">
                        <% for (let i=0; i < deptClasses.length; i++) { %>
                            <% if ((i > 0 && deptClasses[i].year != deptClasses[i-1].year) || (i > 0 && deptClasses[i].block_no != deptClasses[i-1].block_no)) { %>
                                </ul>
                                <hr>
                                <h6 class="block-title">
                                    <small><%= deptClasses[i].course %></small><br>
                                    Year <%= deptClasses[i].year %> - Block <%= deptClasses[i].block_no %>
                                </h6>
                                <ul class="list-group panel-menu" id="<%= deptClasses[i].block_id %>"
                                    title="<%= deptClasses[i].course %> <%= deptClasses[i].year %> - <%= deptClasses[i].block_no %>">
                            <% } %>
                                <button type="button" title="<%= deptClasses[i].subject %>" 
                                    itemid="<%= deptClasses[i].subj_id %>"
                                    class="list-group-item list-group-item-action menu-item"
                                    aria-valuemax="<%= deptClasses[i].req_hours || 0 %>"
                                    aria-valuenow="<%= deptClasses[i].assigned_time || 0 %>">
                                    <p class="text-truncate m-0"><%= deptClasses[i].subject %></p>
                                </button>
                        <% } %>
                        </ul>
                    </div>
                </div>
            <% } else { %>
                <div class="collapse" id="department-classes">
                    <p>No more classes to assign</p>
                </div>
            <% } %>
            <a type="button" class="collapse-btn" data-mdb-toggle="collapse" data-mdb-target="#other-classes" 
                aria-expanded="false"><i class="fas fa-caret-down me-2"></i><text>Other Classes</text>
            </a>
            <% if (otherClasses.length> 0) { %>
                <div class="collapse" id="other-classes">
                    <div>
                        <h6 class="block-title"><small><%= otherClasses[0].course %></small><br>
                            Year <%= otherClasses[0].year %> - Block <%= otherClasses[0].block_no %>
                        </h6>
                        <ul class="list-group panel-menu">
                        <% for (let i=0; i < otherClasses.length; i++) { %>
                            <% if (i> 0 && otherClasses[i].year != otherClasses[i-1].year) { %>
                                </ul>
                                <hr>
                                <h6 class="block-title"><small><%= otherClasses[i].course %></small><br>
                                    Year <%= otherClasses[i].year %> - Block <%= otherClasses[i].block_no %>
                                </h6>
                                <ul class="list-group panel-menu" id="<%= otherClasses[i].block_id %>"
                                    title="<%= otherClasses[i].course %> <%= otherClasses[i].year %> - <%= otherClasses[i].block_no %>">
                            <% } %>
                            <button type="button" class="list-group-item list-group-item-action menu-item"
                                itemid="<%= otherClasses[i].id %>"
                                title="<%= otherClasses[i].subject %>" id="<%= otherClasses[i].id %>"
                                aria-valuemax="<%= otherClasses[i].req_hours || 0 %>"
                                aria-valuenow="<%= otherClasses[i].assigned_time || 0 %>">
                                <p class="text-truncate m-0"><%= otherClasses[i].subject %></p>
                            </button>
                        <% } %>
                        </ul>
                    </div>
                </div>
            <% } else { %>
                <div class="collapse" id="other-classes">
                    <p>No more classes to assign</p>
                </div>
            <% } %>
        </div>
    </div>
    <div>
        <nav aria-label="Schedule Navigation for Faculty">
            <ul class="pagination" id="schedule-nav">
                <% if (prevFaculty) { %>
                    <li class="page-item">
                        <a href="/schedule/faculty?term=<%= term.code %>&id=<%= prevFaculty.faculty_id %>"
                            class="page-link me-2" type="button" ><i class="fas fa-chevron-left"></i></a>
                        <p class="prev page-label"><%= prevFaculty.name %></p>
                    </li>
                <% } else { %>
                    <li class="page-item disabled">
                        <a class="page-link me-2" type="button"><i class="fas fa-chevron-left"></i></a>
                        <p class="prev page-label"></p>
                    </li>
                <% } %>

                <% if (nextFaculty) { %>
                    <li class="justify-content-end page-item" id="<%= nextFaculty.id %>">
                        <p class="next page-label"><%= nextFaculty.name %></p>
                        <a href="/schedule/faculty?term=<%= term.code %>&id=<%= nextFaculty.faculty_id %>" 
                            class="page-link ms-2" type="button"><i class="fas fa-chevron-right"></i></a>
                    </li>
                <% } else { %>
                    <li class="justify-content-end page-item disabled">
                        <p class="next page-label"></p>
                        <a class="page-link ms-2" type="button"><i class="fas fa-chevron-right"></i></a>
                    </li>
                <% } %>
            </ul>
        </nav>
        <% const {faculty_id, status, pref_status, pref_subjs, teach_load, classes} = current %>
        <div class="about">
            <form method="post" target="export_schedule" action="/schedule/download/<%= term.code %>/faculty" 
                class="d-flex" onsubmit="window.open('_blank','export_schedule');">
                <h4 class="page-title"><%= name %></h4>
                <input type="hidden" name="id" value="<%= faculty_id %>">
                <input type="hidden" name="name" value="<%= name %>">
                <button type="submit" class="ms-4 btn btn-secondary btn-floating" title="Export schedules">
                    <i class="fas fa-cloud-arrow-down fa-lg"></i>
                </button>
            </form>
            <h6 class="text-muted"><%= faculty_id %></h6>
            <p>
                <b>Employment Status:</b> <%= status %><br>
                <b>Faculty Load:</b> <%= teach_load %><br>
                <% if (pref_status == 'submitted') { %>
                <b>Preferred Subjects:</b> <%= pref_subjs.join(", ") %>
                <% } else { %>
                <b>Preference status:</b> <%= pref_status %>
                <% } %>
            </p>
        </div>
        <div class="scheduler">
            <div></div>
            <div class="days">
                <div>MON</div>
                <div>TUE</div>
                <div>WED</div>
                <div>THU</div>
                <div>FRI</div>
                <div>SAT</div>
                <div>SUN</div>
            </div>
            <div class="times">
                <div>7 AM</div>
                <div>8 AM</div>
                <div>9 AM</div>
                <div>10 AM</div>
                <div>11 AM</div>
                <div>12 PM</div>
                <div>1 PM</div>
                <div>2 PM</div>
                <div>3 PM</div>
                <div>4 PM</div>
                <div>5 PM</div>
                <div>6 PM</div>
                <div>7 PM</div>
                <div>8 PM</div>
                <div>9 PM</div>
                <div>10 PM</div>
            </div>
            <div class="schedules">
                <div class="sched-grid">
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                </div>
                <div class="sched-body">
                    <% for (const schedule of classes) { %>
                        <div class="sched-block" data-mdb-toggle="tooltip" data-mdb-html="true"
                            <% if (schedule.room) { %>
                            title="<b><%= schedule.subject %></b><br><small><%= schedule.year %>-<%= schedule.block_no %> <%= schedule.course %><br><i><%= schedule.mode %> @ <%= schedule.room %></i></small>"
                            <% } else { %>
                            title="<b><%= schedule.subject %></b><br><small><%= schedule.year %>-<%= schedule.block_no %> <%= schedule.course %><br><i><%= schedule.mode %></i></small>"
                            <% } %>
                            style="grid-column: <%= schedule.day %> / span 1; grid-row: <%= schedule.start %> / <%= schedule.end %>;">
                            <h6 class="text-break"><%= schedule.subject %></h6>
                            <p class="text-truncate"><small>
                                <%= schedule.year %>-<%= schedule.block_no %> <%= schedule.course %><br>
                                <% if (schedule.room) { %>
                                    <i><%= schedule.mode %> @ <%= schedule.room %></i>
                                <% } else { %>
                                    <i><%= schedule.mode %></i>
                                <% } %>
                            </small></p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/lib/display-dropdown.js"></script>
<script>
    const startHeightSched = <%- JSON.stringify(Math.min(...classes.map(c => c.start) )) %>;
    
    if (startHeightSched > 9) {
        $(document).ready(() => setTimeout(() => {
            $(".main-view>div:last-child").stop().animate({scrollTop: startHeightSched * 43 + 235}, 1000, 'swing');
        }, 300));
    }
    
    const addClass = (facultyID, schedule) => new Promise((resolve, reject) => {
        $.post("/api/schedules/<%= term.id %>",
            { faculty: facultyID, schedule: schedule},
            () => location.reload(),
            "json"
        ).fail((error) => {
            console.log(error);
            reject(error);
        });
    });

    displayDropMenu($("#class-day"), "Pick Day");
    displayDropMenu($("#class-mode"), "Pick Mode");

    $(".menu-item").click((event) => {
        const newClass = event.currentTarget;
        $("#class-subject").text(newClass.title).attr("aria-valuenow", newClass.getAttribute("itemid"));
        
        $("#class-hours").text(`${newClass.ariaValueNow} / ${newClass.ariaValueMax}`);
        const block = $(newClass).closest(".panel-menu");
        $("#class-block").text(block.attr("title")).attr("aria-valuenow", block.attr("id"));
        newClassForm.show();
    });

    $("[aria-labelledby='class-day'] > li > a.dropdown-item").click((event) => {
        const dayIndex = event.currentTarget.getAttribute("data-cts-enum");
        if (!dayIndex) return $("#class-day").attr("aria-valuenow", null);

        $("#class-day").attr("aria-valuenow", dayIndex);
        $("#class-start").focus();
    });

    $("[aria-labelledby='class-mode'] > li > a.dropdown-item").click((event) => {
        const modeIndex = event.currentTarget.getAttribute("data-cts-enum");
        if (!modeIndex) return $("#class-room").attr("aria-valuenow", null);

        $("#class-mode").attr("aria-valuenow", modeIndex);
        if (modeIndex == 1) {
            $("#class-room").prop("disabled", false).focus();
        } else if (modeIndex <= 3) {
            $("#class-room").prop("disabled", true);
        }
    })

    $("#confirm-new-class").click(async (event) => {
        const day = $("#class-day");
        const start = $("#class-start");
        const end = $("#class-end");
        const reqMinutes = parseFloat($("#class-hours").text().slice(-1)) * 60;

        if (day.text() == "Pick Day" || !start.val() || !end.val()) {
            return console.error("Missing schedule input.");
        } else if (start.val() > end.val()) {
            return console.error("Start time must be earlier than end time");
        }

        let startTime = roundMinutes(start.val(), 30);
        if (startTime < 7 * 60) {
            return console.error("Class must start on or later than 7AM");
        }
        
        
        let endTime = roundMinutes(end.val(), 30);
        if (endTime > 22 * 60) {
            return console.error("Class must end on or before 10PM");
        } else if (end - start > reqMinutes) {
            console.error("Assigned time exceeds required hours.");
            endTime = Math.trunc(startTime + reqMinutes);
        }

        console.log(day.attr("aria-valuenow"), startTime, endTime);
        try {
            await addClass($(".page-title").attr("id"), {
                subject: $("#class-subject").attr("aria-valuenow"),
                mode: $("#class-mode").attr("aria-valuenow") || 1,
                room: $("#class-room").val().toLowerCase(),
                block: $("#class-block").attr("aria-valuenow"),
                day: day.attr("aria-valuenow"),
                start: startTime,
                end: endTime,
                partial: ($("#class-hours").text().split(" ")[0] != "0")
            });
        } catch (error) {
            console.error(error);
        }
    });

    function roundMinutes(time, nearestMinutes = 1) {
        let [hours, mins] = time.split(":");
        let toMins = parseInt(hours) * 60 + parseInt(mins);
        const rounded = Math.round(toMins / nearestMinutes) * nearestMinutes;
        const finalMins = rounded % 60;
        const finalHours = (rounded - finalMins);
        return finalHours + finalMins;
    }
</script>