<% const {prevFaculty, nextFaculty, current} = schedule %>
<% const {id, name} = current %>
<% if (current.sched_status == 'open') { %>
<div class="modal fade" id="schedule-class" data-mdb-backdrop="static" data-mdb-keyboard="false"
    tabindex="-1" aria-labelledby="schedule-class-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="schedule-class-label">Assign New Class</h5>
                <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <label for="class-subject">Subject:</label><span id="class-subject"></span><br>
                <label for="class-block">Block:</label><span id="class-block"></span><br>
                <label for="class-faculty">Faculty:</label>
                <span id="class-faculty"><%= name %></span><br>
                <label for="class-hours">Assigned hours:</label>
                <span id="class-hours"></span>
                <hr>
                <p><small>Class Schedule</small></p>
                <div class="input-group mb-2">
                    <div class="dropdown">
                        <a class="text-primary dropdown-toggle input-group-text rounded-0 rounded-start" type="button"
                            data-mdb-toggle="dropdown" aria-expanded="false" id="class-day">Pick Day</a>
                        <ul class="dropdown-menu" aria-labelledby="class-day">
                            <li><a class="dropdown-item" role="button" data-cts-enum="1">MONDAY</a></li>
                            <li><a class="dropdown-item" role="button" data-cts-enum="2">TUESDAY</a></li>
                            <li><a class="dropdown-item" role="button" data-cts-enum="3">WEDNESDAY</a></li>
                            <li><a class="dropdown-item" role="button" data-cts-enum="4">THURSDAY</a></li>
                            <li><a class="dropdown-item" role="button" data-cts-enum="5">FRIDAY</a></li>
                            <li><a class="dropdown-item" role="button" data-cts-enum="6">SATURDAY</a></li>
                            <li><a class="dropdown-item" role="button" data-cts-enum="7">SUNDAY</a></li>
                            <li><hr class="dropdown-divider m-0"></li>
                            <li><a class="dropdown-item text-danger cancel" role="button">Cancel</a></li>
                        </ul>
                    </div>
                    <span class="input-group-text"><i class="fas fa-at"></i></span>
                    <input type="time" id="class-start" class="form-control">
                    <span class="input-group-text"> - </span>
                    <input type="time" id="class-end" class="form-control">
                </div>
                <div class="input-group mb-3">
                    <div class="dropdown">
                        <a class="text-primary dropdown-toggle input-group-text rounded-0 rounded-start" type="button"
                            data-mdb-toggle="dropdown" aria-expanded="false" id="class-mode">Pick Mode</a>
                        <ul class="dropdown-menu" aria-labelledby="class-mode">
                            <li><a class="dropdown-item" role="button" data-cts-enum="1">F2F</a></li>
                            <li><a class="dropdown-item" role="button" data-cts-enum="2">Online</a></li>
                            <li><a class="dropdown-item" role="button" data-cts-enum="3">Blended</a></li>
                            <li>
                                <hr class="dropdown-divider m-0">
                            </li>
                            <li><a class="dropdown-item text-danger cancel" role="button">Cancel</a></li>
                        </ul>
                    </div>
                    <div class="dropdown w-100">
                        <input type="text" id="class-room" class="text-start form-control input-group-text rounded-0 rounded-end" placeholder="Room no."
                            data-mdb-toggle="dropdown" aria-expanded="false" autocomplete="off" disabled>
                        <ul class="dropdown-menu" aria-labelledby="class-room">
                            <% for (const {id, name, bldg} of classrooms) { %>
                                <li><a role="button" class="dropdown-item" itemid="<%= id %>"><%= name %>, <%= bldg %></a></li>
                            <% } %>
                            <li><i class="dropdown-item-text text-muted" id="avail-rooms-alert"></i></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer d-flex justify-content-end">
                <button type="button" class="btn btn-secondary me-2" data-mdb-dismiss="modal">cancel</button>
                <button type="button" class="btn btn-warning me-2" id="reset-schedule">reset</button>
                <button type="button" class="btn btn-primary" id="change-schedule" data-mdb-dismiss="modal">change</button>
                <button type="button" class="btn btn-primary" id="add-schedule" data-mdb-dismiss="modal">assign</button>
            </div>
        </div>
    </div>
</div>
<% } %>
<div class="main-view">
    <div class="w-100">
        <nav aria-label="Schedule Navigation for Faculty">
            <ul class="pagination" id="schedule-nav">
                <% if (prevFaculty) { %>
                    <li class="page-item">
                        <a href="/schedule/faculty?term=<%= term.code %>&id=<%= prevFaculty.id %>"
                            class="page-link me-2" type="button" ><i class="fas fa-chevron-left"></i></a>
                        <p class="prev page-label"><%= prevFaculty.name %></p>
                    </li>
                <% } else { %>
                    <li class="page-item disabled">
                        <a class="page-link me-2" type="button"><i class="fas fa-chevron-left"></i></a>
                        <p class="prev page-label"></p>
                    </li>
                <% } %>
                <% if (nextFaculty) { %>
                    <li class="justify-content-end page-item">
                        <p class="next page-label"><%= nextFaculty.name %></p>
                        <a href="/schedule/faculty?term=<%= term.code %>&id=<%= nextFaculty.id %>" 
                            class="page-link ms-2" type="button"><i class="fas fa-chevron-right"></i></a>
                    </li>
                <% } else { %>
                    <li class="justify-content-end page-item disabled">
                        <p class="next page-label"></p>
                        <a class="page-link ms-2" type="button"><i class="fas fa-chevron-right"></i></a>
                    </li>
                <% } %>
            </ul>
        </nav>
        <% const {status, sched_status, pref_status, new_pref_subjs, old_pref_subjs, teach_load, assigned_load, consultation} = current %>
        <div class="about">
            <div class="d-flex">
                <h4 class="page-title">
                    <%= name %>
                </h4>
                <form method="post" target="export_schedule" action="/schedule/download/<%= term.code %>/faculty"
                    onsubmit="window.open('_blank','export_schedule');">
                    <input type="hidden" name="id" value="<%= id %>">
                    <input type="hidden" name="name" value="<%= name %>">
                    <button type="submit" class="ms-4 btn btn-secondary btn-floating" title="Export schedules">
                        <i class="fas fa-cloud-arrow-down fa-lg"></i>
                    </button>
                </form>
                <% if (sched_status == 'open') { %>
                <form action="/schedule/save/<%= term.code %>" method="post">
                    <input type="hidden" name="facultyID" value="<%= id %>">
                    <button type="submit" class="ms-2 btn btn-primary btn-floating" id="lock-schedule" title="Save schedules">
                        <i class="fas fa-lock fa-lg me-2"></i>
                    </button>
                </form>
                <button class="ms-2 btn btn-warning btn-floating" id="clear-schedule" title="Clear schedule">
                    <i class="fas fa-arrow-rotate-left fa-lg me-2"></i>
                </button>
                <% } else if (sched_status == 'saved') { %>
                    <form action="/schedule/unsave/<%= term.code %>" method="post">
                        <input type="hidden" name="facultyID" value="<%= id %>">
                        <button type="submit" class="ms-2 btn btn-danger btn-floating" id="lock-schedule" title="Unlock schedules">
                            <i class="fas fa-unlock fa-lg me-2"></i>
                        </button>
                    </form>
                <% } %>
            </div>
            <p>
                <b>Employment Status:</b> <%= status %><br>
                <% if (consultation) { %>
                    <b>Consultation Hours:</b> <%- consultation %><br>
                <% } %>
                <b>Faculty Load:</b> 
                <% if (assigned_load > teach_load) { %>
                    <span class="text-danger" id="assigned-load"><%= assigned_load %></span> / <span><%= teach_load %></span>
                <% } else { %>
                    <span id="assigned-load"><%= assigned_load %></span> / <span><%= teach_load %></span>
                <% } %>
                <br>
                <b>Schedule Status:</b> <%= sched_status %>
            </p>
            <hr>
            <b>PREFERENCE</b>
            <p>
                <% if (pref_status == 'submitted') { %>
                    <b>Form Status:</b> <span class="text-success"><%= pref_status %></span><br>
                    <b>Subjects:</b> <%= new_pref_subjs.join(", ") %><br>
                <% } else { %>
                    <b>Form Status:</b> <%= pref_status %></span><br>
                <% } %>
                <% if (old_pref_subjs.length > 0) { %>
                    <b>Previously preferred subjects:</b> <%= old_pref_subjs.join(", ") %>
                <% } %>
            </p>
            <hr>
            <b>Color Guide:</b><br>
            <div class="d-flex align-items-center">
                <div class="color-legend">
                    <span>preferred schedule</span>
                </div>
                <label>Preffered timeslot</label>
                <div class="color-legend ms-4" style="background-color: #F44040;">
                    <span>conflict schedule</span>
                </div>
                <label>Conflict timeslot</label>
                <div class="color-legend ms-4" style="background-color: #D9D9D9;">
                    <span>blank schedule</span>
                </div>
                <label>Blank timeslot</label>
            </div>
        </div>
        <div class="scheduler">
            <div></div>
            <div class="days">
                <div>MON</div>
                <div>TUE</div>
                <div>WED</div>
                <div>THU</div>
                <div>FRI</div>
                <div>SAT</div>
                <div>SUN</div>
            </div>
            <div class="times">
                <div>7 AM</div>
                <div>8 AM</div>
                <div>9 AM</div>
                <div>10 AM</div>
                <div>11 AM</div>
                <div>12 PM</div>
                <div>1 PM</div>
                <div>2 PM</div>
                <div>3 PM</div>
                <div>4 PM</div>
                <div>5 PM</div>
                <div>6 PM</div>
                <div>7 PM</div>
                <div>8 PM</div>
                <div>9 PM</div>
                <div>10 PM</div>
            </div>
            <div class="schedules">
                <div class="sched-grid">
                    <% let grid = new Array(224) %>
                    <% grid.fill(0) %>
                    <% for (let {day, start, end} of current.pref_scheds) { %>
                        <% start-- %>
                        <% for (let i = start; i <= end; i++) { %>
                            <% grid[(i * 7 + day) - 1] = 1 %>
                        <% } %>
                    <% } %>
                    <%- grid.map(pref => pref > 0 ? '<div class="pref-slot"></div>' : '<div></div>').join('') %>
                </div>
                <div class="sched-body">
                    <% for (const schedule of current.classes) { %>
                        <div class="sched-block" data-mdb-toggle="tooltip" data-mdb-html="true"
                            <% if (schedule.room) { %>
                            title="<b><%= schedule.subject %></b><br><small><%= schedule.year %>-<%= schedule.block_no %> <%= schedule.course %><br><i><%= schedule.mode %> @ <%= schedule.room %>,<br><%= schedule.building %></i></small>"
                            <% } else { %>
                            title="<b><%= schedule.subject %></b><br><small><%= schedule.year %>-<%= schedule.block_no %> <%= schedule.course %><br><i><%= schedule.mode %></i></small>"
                            <% } %>
                            style="grid-column: <%= schedule.day %> / span 1; grid-row: <%= schedule.start_time %> / <%= schedule.end_time %>; background-color: <%= schedule.color %>;"
                            aria-valuemin="<%= schedule.start %>" aria-valuemax="<%= schedule.end %>" 
                            aria-valuenow="<%= schedule.day %>" aria-current="<%= schedule.duration %>">
                            <h6 class="text-break subject" itemid="<%= schedule.subj_id %>"><%= schedule.subject %></h6>
                            <p class="text-truncate"><small>
                                <span class="block" itemid="<%= schedule.block_id %>">
                                    <%= schedule.year %>-<%= schedule.block_no %> <%= schedule.course %>
                                </span><br>
                                <% if (schedule.room) { %>
                                    <i>
                                        <span class="mode"><%= schedule.mode %></span> @ 
                                        <span class="room" itemid="<%= schedule.room_id %>"><%= schedule.room %></span>,
                                        <br><span class="building"><%= schedule.building %></span>
                                    </i>
                                <% } else { %>
                                    <i class="mode"><%= schedule.mode %></i>
                                <% } %>
                            </small></p>
                        </div>
                        <div class="sched-options" 
                            style="grid-column: <%= schedule.day %> / span 1; grid-row: <%= schedule.start_time %> / <%= schedule.end_time %>;">
                            <div class="d-flex justify-content-around align-items-center mb-4">
                                <a class="btn btn-floating btn-sm btn-primary edit-schedule"><i class="fas fa-edit"></i></a>
                                <a class="btn btn-floating btn-sm btn-secondary cancel-schedule"><i class="fas fa-times fa-lg"></i></a>
                                <a class="btn btn-floating btn-sm btn-danger delete-schedule"><i class="fas fa-trash-can"></i></a>
                            </div>
                        </div>
                    <% } %>
                    <% for (const schedule of current.partialClasses) { %>
                        <div class="sched-block bg-light text-secondary partial" data-mdb-toggle="tooltip" data-mdb-html="true"
                            <% if (schedule.room) { %>
                            title="<b><%= schedule.subject %></b><br><small><%= schedule.year %>-<%= schedule.block_no %> <%= schedule.course %><br>No professor yet<br><i><%= schedule.mode %> @ <%= schedule.room %>,<br><%= schedule.building %></i></small>"
                            <% } else { %>
                            title="<b><%= schedule.subject %></b><br><small><%= schedule.year %>-<%= schedule.block_no %> <%= schedule.course %><br>No professor yet<br><i><%= schedule.mode %></i></small>"
                            <% } %>
                            style="grid-column: <%= schedule.day %> / span 1; grid-row: <%= schedule.start_time %> / <%= schedule.end_time %>;"
                            aria-valuemin="<%= schedule.start %>" aria-valuemax="<%= schedule.end %>" 
                            aria-valuenow="<%= schedule.day %>" aria-current="<%= schedule.duration %>">
                            <h6 class="text-break subject" itemid="<%= schedule.subj_id %>"><%= schedule.subject %></h6>
                            <p class="text-truncate"><small>
                                <span class="text-danger faculty">No professor yet</span><br>
                                <span class="block" itemid="<%= schedule.block_id %>">
                                    <%= schedule.year %>-<%= schedule.block_no %> <%= schedule.course %>
                                </span><br>
                                <% if (schedule.room) { %>
                                    <i>
                                        <span class="mode"><%= schedule.mode %></span> @ 
                                        <span class="room" itemid="<%= schedule.room_id %>"><%= schedule.room %></span>,
                                        <br><span class="building"><%= schedule.building %></span>
                                    </i>
                                <% } else { %>
                                    <i class="mode"><%= schedule.mode %></i>
                                <% } %>
                            </small></p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
    <% if (current.sched_status == 'open') { %>
        <div class="side-panel">
            <div class="panel-header mx-4 mb-3">
                <h5>Unassigned Classes</h5>
            </div>
            <div class="panel-body pb-5">
                <a type="button" class="collapse-btn" data-mdb-toggle="collapse" data-mdb-target="#department-classes"
                    aria-expanded="false">
                    <i class="fas fa-caret-down me-2"></i><text>Departmental Classes</text>
                </a>
                <% if (deptClasses.length> 0) { %>
                    <div class="collapse show" id="department-classes">
                        <div>
                            <h6 class="block-title">
                                <small><%= deptClasses[0].course %></small><br>
                                Year <%= deptClasses[0].year %> - Block <%= deptClasses[0].block_no %>
                            </h6>
                            <ul class="list-group panel-menu" id="<%= deptClasses[0].block_id %>"
                                title="<%= deptClasses[0].course %> <%= deptClasses[0].year %> - <%= deptClasses[0].block_no %>">
                            <% for (let i=0; i < deptClasses.length; i++) { %>
                                <% if (i > 0 && deptClasses[i].block_id != deptClasses[i-1].block_id) { %>
                                    </ul>
                                    <hr>
                                    <h6 class="block-title">
                                        <small><%= deptClasses[i].course %></small><br>
                                        Year <%= deptClasses[i].year %> - Block <%= deptClasses[i].block_no %>
                                    </h6>
                                    <ul class="list-group panel-menu" id="<%= deptClasses[i].block_id %>"
                                        title="<%= deptClasses[i].course %> <%= deptClasses[i].year %> - <%= deptClasses[i].block_no %>">
                                <% } %>
                                    <button type="button" title="<%= deptClasses[i].subject %>" 
                                        itemid="<%= deptClasses[i].subj_id %>"
                                        class="list-group-item list-group-item-action menu-item<%= deptClasses[i].assigned_time > 0 ? ' text-warning' : '' %>"
                                        aria-valuemax="<%= deptClasses[i].req_hours || 0 %>"
                                        aria-valuenow="<%= deptClasses[i].assigned_time || 0 %>">
                                        <p class="text-truncate m-0">
                                            <%= deptClasses[i].subject %><br>
                                            <% if (deptClasses[i].assigned_time > 0) { %>
                                                <small class="text-muted">Assigned hours: <%= deptClasses[i].assigned_time %> / <%= deptClasses[i].req_hours %></small>
                                            <% } %>
                                        </p>
                                    </button>
                            <% } %>
                            </ul>
                        </div>
                    </div>
                <% } else { %>
                    <div class="collapse show" id="department-classes">
                        <p>No more classes to assign</p>
                    </div>
                <% } %>
                <a type="button" class="collapse-btn" data-mdb-toggle="collapse" data-mdb-target="#other-classes" 
                    aria-expanded="false"><i class="fas fa-caret-down me-2"></i><text>Other Classes</text>
                </a>
                <% if (otherClasses.length> 0) { %>
                    <div class="collapse<%= deptClasses.length > 0 ? '' : ' show'%>" id="other-classes">
                        <div>
                            <h6 class="block-title"><small><%= otherClasses[0].course %></small><br>
                                Year <%= otherClasses[0].year %> - Block <%= otherClasses[0].block_no %>
                            </h6>
                            <ul class="list-group panel-menu" id="<%= otherClasses[0].block_id %>"
                                title="<%= otherClasses[0].course %> <%= otherClasses[0].year %> - <%= otherClasses[0].block_no %>">
                            <% for (let i=0; i < otherClasses.length; i++) { %>
                                <% if (i> 0 && otherClasses[i].block_id != otherClasses[i-1].block_id) { %>
                                    </ul>
                                    <hr>
                                    <h6 class="block-title"><small><%= otherClasses[i].course %></small><br>
                                        Year <%= otherClasses[i].year %> - Block <%= otherClasses[i].block_no %>
                                    </h6>
                                    <ul class="list-group panel-menu" id="<%= otherClasses[i].block_id %>"
                                        title="<%= otherClasses[i].course %> <%= otherClasses[i].year %> - <%= otherClasses[i].block_no %>">
                                <% } %>
                                <button type="button" title="<%= otherClasses[i].subject %>"
                                    class="list-group-item list-group-item-action menu-item<%= otherClasses.assigned_load > 0 ? ' text-warning' : '' %>"
                                    itemid="<%= otherClasses[i].subj_id %>"
                                    aria-valuemax="<%= otherClasses[i].req_hours || 0 %>"
                                    aria-valuenow="<%= otherClasses[i].assigned_time || 0 %>">
                                    <p class="text-truncate m-0">
                                        <%= otherClasses[i].subject %><br>
                                        <% if (otherClasses[i].assigned_time > 0) { %>
                                            <small class="text-muted">Assigned hours: <%= otherClasses[i].assigned_time %> / <%= otherClasses[i].req_hours %></small>
                                        <% } %>
                                        <small></small>
                                    </p>
                                </button>
                            <% } %>
                            </ul>
                        </div>
                    </div>
                <% } else { %>
                    <div class="collapse show" id="other-classes">
                        <p>No more classes to assign</p>
                    </div>
                <% } %>
            </div>
        </div>
        <% } %>
</div>
<% if (current.sched_status == 'open') { %>
<script src="/lib/display-dropdown.js"></script>
<script src="/lib/schedule-util.js"></script>
<script>
    let currentSched = { faculty: "<%= id %>" };
    displayDropMenu($("#class-day"), "Pick Day");
    displayDropMenu($("#class-mode"), "Pick Mode");

    const addClass = (schedule) => new Promise((resolve, reject) => {
        $.post("/api/schedules/<%= term.id %>",
            { schedule: schedule }, () => location.reload()
        ).fail((error) => reject(error.responseJSON));
    });

    const manageClass = (action, newSchedule = {}) => new Promise((resolve, reject) => {
        $.post(
            "/api/schedule/<%= term.id %>",
            { oldSched: currentSched, newSched: newSchedule, action: action }, 
            () => resolve(location.reload())
        ).fail((error) => reject(error.responseJSON));
    });

    const getConflictRooms = (schedule) => new Promise((resolve, reject) => {
        $.get(
            "/api/unavailable-rooms/<%= term.id %>", schedule, 
            (data) => resolve(data.rooms)
        ).fail((error) => reject(error.responseJSON));
    });

    const getBlockSchedule = (about) => new Promise((resolve, reject) => {
        $.get(
            "/api/schedule/<%= term.id %>", about, 
            (data) => resolve(data)
        ).fail((error) => reject(error.responseJSON));
    });

    $(".menu-item").click((event) => {
        currentSched = {};
        const newClass = event.currentTarget;
        $("#schedule-class-label").text("Assign New Class");
        $("#class-subject").text(newClass.title).attr("aria-valuenow", newClass.getAttribute("itemid"));
        const assignedHours = parseFloat(newClass.ariaValueNow);
        const reqHours = parseInt(newClass.ariaValueMax);
        $("#class-hours")
            .text(`${assignedHours} / ${reqHours}`)
            .attr("aria-valuemax", reqHours - assignedHours)
            .attr("aria-valuemin", assignedHours);
        
        $("#class-start").val(null);
        $("#class-end").val(null);
        $(`ul[aria-labelledby='class-day']>li>a.dropdown-item.cancel`).trigger("click");
        $(`ul[aria-labelledby='class-mode']>li>a.dropdown-item.cancel`).trigger("click");

        const block = $(newClass).closest(".panel-menu");
        $("#class-block").text(block.attr("title")).attr("aria-valuenow", block.attr("id"));

        $("#add-schedule").show();
        $("#change-schedule, #reset-schedule").hide();
        scheduleForm.show();
    });
    
    const schedBlocks = $(".sched-block").click(async (event) => {
        const prevClass = event.currentTarget;
        $("#schedule-class-label").text("Change Class Schedule");
        const [subj, block, mode, room, bldg] = $(prevClass).find(".subject, .block, .mode, .room, .building").get();
        $("#class-subject").text(subj.textContent).attr("aria-valuenow", subj.getAttribute("itemid"));
        $("#class-block").text(block.textContent).attr("aria-valuenow", block.getAttribute("itemid"));
        $("#class-start").val(prevClass.ariaValueMin);
        $("#class-end").val(prevClass.ariaValueMax);
        $("#class-hours").text(prevClass.ariaCurrent).attr("aria-valuemax", prevClass.ariaCurrent);

        currentSched.faculty = prevClass.classList.contains("partial") ? null : "<%= id %>";
        currentSched.block = block.getAttribute("itemid");
        currentSched.subject = subj.getAttribute("itemid");
        currentSched.day = prevClass.ariaValueNow;
        currentSched.start_time = prevClass.ariaValueMin;
        currentSched.end_time = prevClass.ariaValueMax;
        currentSched.start = roundMinutes(prevClass.ariaValueMin);
        currentSched.end = roundMinutes(prevClass.ariaValueMax);
        currentSched.mode = mode.textContent;
        $(`ul[aria-labelledby='class-day']>li:nth-child(${prevClass.ariaValueNow})>a.dropdown-item`).trigger("click");
        $(`ul[aria-labelledby='class-mode']>li>a.dropdown-item:contains(${mode.textContent})`).trigger("click");

        if (room && bldg) {
            currentSched.room_name = `${room.textContent}, ${bldg.textContent}`;
            currentSched.room_id = room.getAttribute("itemid");
            $("#class-room")
                .val(`${room.textContent}, ${bldg.textContent}`)
                .attr("aria-valuenow", currentSched.room_id);
        } else {
            delete currentSched.room_name;
            delete currentSched.room_id;
        }

        try {
            let {classes} = await getBlockSchedule({
                blockID: currentSched.block, facultyID: "<%= id %>"
            });
            const grid = $(".sched-grid >div").get();
            let class_no = 0;
            for (let {day, start_time, end_time} of classes) {
                start_time = parseInt(start_time);
                end_time = parseInt(end_time);
                for (let i = start_time; i < end_time; i++) {
                    const tile = grid[(i * 7 + day) - 1];
                    tile.classList.add("conflict-slot");
                }
                class_no++;
            }
            console.log(class_no);
        } catch (error) {
            console.log(error);
        }
        
        $("#add-schedule").hide();
        $("#reset-schedule, #change-schedule").show();
        $(schedBlocks).hide();
        $(".sched-options").hide().get(schedBlocks.indexOf(event.currentTarget)).style.display = "block";
    }).get();

    $(".edit-schedule").click(() => scheduleForm.show());

    $(".cancel-schedule").click(() => {
        $(".sched-grid >div.conflict-slot").removeClass("conflict-slot");
        $(schedBlocks).show();
        $(".sched-options").hide();
    });

    $("[aria-labelledby='class-room'] > li > a.dropdown-item").click((event) => {
        const classroom = event.currentTarget;
        $("#class-room")
            .val(classroom.textContent)
            .attr("aria-valuenow", classroom.getAttribute("itemid"));
    });
    
    $("[aria-labelledby='class-day'] > li > a.dropdown-item").click((event) => {
        const dayIndex = event.currentTarget.getAttribute("data-cts-enum");
        if (!dayIndex) return $("#class-day").attr("aria-valuenow", null);

        $("#class-day").attr("aria-valuenow", dayIndex);
        $("#class-start").focus();
    });

    $("[aria-labelledby='class-mode'] > li > a.dropdown-item").click((event) => {
        const modeIndex = event.currentTarget.getAttribute("data-cts-enum");
        if (!modeIndex) {
            $("#class-room").val(null).prop("disabled", true);
            return $("#class-room").attr("aria-valuenow", null);
        }

        $("#class-mode").attr("aria-valuenow", modeIndex);
        if (modeIndex == 1) {
            $("#class-room").prop("disabled", false);
        } else {
            $("#class-room").val(null).prop("disabled", true);
        }
    });
    
    $("#class-room")
        .focusin((event) => filterRooms(event.currentTarget.value))
        .focusout((event) => {
            if (!event.currentTarget.getAttribute("itemid")) {
                $("#class-room")
                .val(currentSched.room_name)
                .attr("aria-valuenow", currentSched.room_id);
            }
        })
        .on("input", (event) => {
            filterRooms(event.currentTarget.value);
        });

    $("#confirm-alert").click((event) => {
        event.currentTarget.removeAttribute("data-mdb-target")
        event.currentTarget.removeAttribute("data-mdb-toggle");
    });

    $("#reset-schedule").click(async (event) => {
        console.log(currentSched);
        $("#class-end").val(currentSched.end_time);
        $("#class-start").text(currentSched.start_time);
        $(`ul[aria-labelledby='class-day']>li:nth-child(${currentSched.day})>a.dropdown-item`).trigger("click");
        $(`ul[aria-labelledby='class-mode']>li>a.dropdown-item:contains(${currentSched.mode})`).trigger("click");
        if (currentSched.room_id) {
            $("#class-room")
                .val(currentSched.room_name)
                .attr("aria-valuenow", currentSched.room_id);
        }
    });

    $("#add-schedule").click(async (event) => {
        const validTime = validateScheduleInput();
        switch (true) {
            case validTime < 0:
                $("#confirm-alert").attr("data-mdb-target", "#schedule-class").attr("data-mdb-toggle", "modal");
            case validTime == -1:
                alertModal.show(2, "Missing schedule input", "Fill in week day, start time and end time.");
                return;
            case validTime == -2:
                alertModal.show(2, "Invalid time input", "End time is earlier than start time");
                return;
            case validTime == -3:
                alertModal.show(2, "Start time is too early", "Class must start on or later than 7AM");
                return;
            case validTime == -4:
                alertModal.show(2, "End time is too late", "Class must end on or before than 10PM");
                return;
            case validTime == -5:
                alertModal.show(2, "Invalid time input", "Assigned time exceeds required hours.");
                return;
            default:
                break;
        }

        let mode = $("#class-mode").attr("aria-valuenow");
        if (!mode) {
            $(`ul[aria-labelledby='class-mode']>li:nth-child(1)>a.dropdown-item`).trigger("click");
            mode = 1;
        }
        const classroom = $("#class-room").attr("aria-valuenow");
        if (!classroom && mode == 1) {
            $("#confirm-alert").attr("data-mdb-target", "#schedule-class").attr("data-mdb-toggle", "modal");
            return alertModal.show(
                2, "Missing room input",
                "Please choose a classroom for F2F class."
            );
        }
        
        try {
            await addClass({
                ...validTime,
                faculty: "<%= id %>",
                subject: $("#class-subject").attr("aria-valuenow"),
                mode: mode,
                room: classroom,
                block: $("#class-block").attr("aria-valuenow"),
                partial: parseFloat($("#class-hours").attr("aria-valuemin")) > 0 ? 1 : 0,
            });
        } catch (eResponse) {
            console.log(eResponse);
            if (eResponse) {
                if (eResponse.redirect) {
                    location.replace(eResponse.redirect);
                }
                if (eResponse.message) {
                    $("#confirm-alert").attr("data-mdb-target", "#schedule-class").attr("data-mdb-toggle", "modal");
                    alertModal.show(...Object.values(eResponse.message));
                }
            } else {
                $("#confirm-alert").attr("data-mdb-target", "#schedule-class").attr("data-mdb-toggle", "modal");
                alertModal.show(0, "Server error", "Unexpected error occured, please try again later.");
            }
        }
    });

    $("#change-schedule").click(async (event) => {
        const validTime = validateScheduleInput();

        console.log(validTime);
        switch (true) {
            case validTime < 0:
                $("#confirm-alert").attr("data-mdb-target", "#schedule-class").attr("data-mdb-toggle", "modal");
            case validTime == -1:
                alertModal.show(2, "Missing schedule input", "Fill in week day, start time and end time.");
                return;
            case validTime == -2:
                alertModal.show(2, "Invalid time input", "End time is earlier than start time");
                return;
            case validTime == -3:
                alertModal.show(2, "Start time is too early", "Class must start on or later than 7AM");
                return;
            case validTime == -4:
                alertModal.show(2, "End time is too late", "Class must end on or before than 10PM");
                return;
            case validTime == -5:
                alertModal.show(2, "Invalid time input", "Assigned time exceeds required hours.");
                return;
            case validTime == -6:
                alertModal.show(2, "Invalid time input", "Start time and end time is the same.");
                return;
            default:
                break;
        }

        let mode = $("#class-mode").attr("aria-valuenow");
        if (!mode) {
            $(`ul[aria-labelledby='class-day']>li:nth-child(1)>a.dropdown-item`).trigger("click");
            mode = 1;
        }
        const classroom = $("#class-room").attr("aria-valuenow") || currentSched.room_id;
        if (!classroom && mode == 1) {
            $("#confirm-alert").attr("data-mdb-target", "#schedule-class").attr("data-mdb-toggle", "modal");
            return alertModal.show(
                2, "Missing room input",
                "Please choose a classroom for F2F class."
            );
        };
        
        try {
            await manageClass("change", ({
                ...validTime,
                faculty: "<%= id %>",
                subject: $("#class-subject").attr("aria-valuenow"),
                mode: mode,
                room: classroom,
                block: $("#class-block").attr("aria-valuenow")
            }));
        } catch (eResponse) {
            if (eResponse) {
                if (eResponse.redirect) {
                    location.replace(eResponse.redirect);
                }
                if (eResponse.message) {
                    console.log(eResponse.message);
                    $("#confirm-alert").attr("data-mdb-target", "#schedule-class").attr("data-mdb-toggle", "modal");
                    alertModal.show(...Object.values(eResponse.message));
                }
            } else {
                $("#confirm-alert").attr("data-mdb-target", "#schedule-class").attr("data-mdb-toggle", "modal");
                alertModal.show(0, "Server error", "Unexpected error occured, please try again later.");
            }
        }
    });

    $(".delete-schedule").click(async (event) => {
        try {
            await manageClass("delete");
        } catch (eResponse) {
            if (eResponse) {
                if (eResponse.redirect) {
                    location.replace(eResponse.redirect);
                }
                if (eResponse.message) {
                    $("#confirm-alert").attr("data-mdb-target", "#schedule-class").attr("data-mdb-toggle", "modal");
                    alertModal.show(...Object.values(eResponse.message));
                }
            } else {
                $("#confirm-alert").attr("data-mdb-target", "#schedule-class").attr("data-mdb-toggle", "modal");
                alertModal.show(0, "Server error", "Unexpected error occured, please try again later.");
            }
        }
    });

    $("#clear-schedule").click(() => {
        $("#accept-alert, #reject-alert, #confirm-alert").toggle();
        alertModal.show(
            2, "Are you sure?", 
            "By clicking yes, you will remove all classes assigned to<br>Prof. <%= name %>"
        );
    });

    $("#accept-alert, #reject-alert").click(() => $("#accept-alert, #reject-alert, #confirm-alert").toggle());
</script>
<% } %>